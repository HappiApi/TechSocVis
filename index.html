<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <title>D3 Page Template</title>
        <script type="text/javascript" src="d3/d3.min.js"></script>
        <script type="text/javascript" src="axios/axios.min.js"></script>
        <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.2.0/lodash.js"></script>

        <style>
            #date {
                display: inline-block;
                position: fixed;
                z-index: 10;
                top: 50px;
                right: 50px;

            }

            svg {
                position: fixed;
            }

            .axis path,
            .axis line {
                fill: none;
                stroke: black;
                shape-rendering: crispEdges;
            }
            
            .axis text {
                font-family: sans-serif;
                font-size: 14px;
            }

            #breakTag {
                text-align: center;
                top :100px;
                right: 100px;
                position: fixed;
            }

            #eventList {
                position: fixed;
                top: 50px;
                left: 90px;
            }


        </style>
    </head>
    <body>
        <div id="illus">
            <h1 id="date"></h1>
            <h3 id="breakTag"></h3>
            <div id="eventList"></div>
        </div>
        <script type="text/javascript">
            // Your beautiful D3 code will go here

            var memberData;
            var eventData;
            var facebookData = [];
            var margin = {
                top: 50,
                right: 50,
                bottom: 50,
                left: 50
            }

            var fullHeight = 500;
            var fullWidth = 1000;
            var height = fullHeight - (margin.top + margin.bottom);
            var width = fullWidth - (margin.right + margin.left);

            var errorHeight = 300
            d3.csv("membership.csv", function(e,r){
                memberData = r;

                d3.json("https://uclutech.com/data/events.json", function(error, response){
                    eventData = response;

                    getFacebookEvents().then(function(d){
                        facebookData = d;
                        eventData = combineEventData(eventData, d)
                        visualization();
                    });
                })
            })

            function getFacebookEvents() {

                var ACCESS_TOKEN = "CAAK3kpvZBViIBAAs9SZBVlLXDnQzO8bZAvwjiB7UdzBuKPJsSqiSiYoND0ct8GQsmcGmBD5Y8pCTptMSNTNp9OflfyBLZBq0ijGoLZCbJifZCNcTtQjHh2MkdlW7fmOgFPymnrSIQpVOmz1cQA7TIwzUwzVzvcTtWkOag9OXQvVZC2jMKGU1gUW3fQQWPOZCLCoZD"

                var ids = eventData
                    .map(function(d){ return d.facebook_id })
                    .filter(function(d){ return d != null });

                var chunkedIds = _.chunk(ids, 50);

                function getFacebookEventsBatch(ids) {
                  return axios.get("https://graph.facebook.com/v2.5/", {
                    params: {
                      access_token: ACCESS_TOKEN,
                      ids : ids.join(","),
                      fields: [
                        "name",
                        "start_time",
                        "attending_count",
                        "interested_count"
                      ].join(","),
                      json: true
                    }
                  })
                  .then(function(response) {
                    return response.data;
                  });
                }

                return Promise.all(
                    chunkedIds.map(function(d) { return getFacebookEventsBatch(d); })
                ).then(function(batches) {
                    return _.assign.apply(null, batches);
                })
            }

            function combineEventData(eventData, facebookData) {         
                return eventData.map(function(d) {
                    fbObject = _.find(facebookData, ["id", d.facebook_id]);
                    return _.assignIn(fbObject, d);
                })
            }

            function visualization() {

                function calcHeight() {
                    var scrollPixels = pixelTicks * days;
                    d3.select("body")
                        .style("height", window.innerHeight + scrollPixels + "px")
                }

                var eventChart = d3.select("#illus").append("svg")
                                .attr("height", fullHeight)
                                .attr("width", fullWidth)
                                .append("g")
                                .attr("height", height)
                                .attr("width", width) 
                                .attr("transform", "translate("+margin.left+","+margin.top+")")
                                .style("opacity", 1)    

                var pixelTicks = 10;
                var baseTime = new Date(2015, 08, 26);
                var currentTime = new Date(2015, 08, 26);
                var previousTickDay = new Date(2015, 08, 25);
                var msPerDay = 86400000;

                // From 26th Sept 2015 - 1st March 2016 (not including end date)
                var days = 157
                var winterBreakStart = new Date(2015, 11, 19)
                var winterBreakEnd = new Date(2016, 00, 10)

                var body = d3.select("body").node();
                var eventTimeFormat = d3.time.format("%Y-%m-%d %H:%M")

                function init() {
                    updateTimeGraphic();
                    calcHeight();
                }

                init();  
                window.onresize = init;
                
                function getTicks() {
                    return Math.floor(body.scrollTop/pixelTicks)
                }

                function updateTime() {
                    currentTime.setTime(baseTime.getTime() + getTicks() * msPerDay);
                    // console.log(currentTime, baseTime, getTicks(), body.scrollTop);

                }

                function currentDayEvent(eventObj) {
                    return eventTimeFormat.parse(eventObj.start_time).toDateString() === currentTime.toDateString()
                }

                function getTodaysEvent() {
                    var todaysEvents = [];
                    for (var i=0; i<eventData.length; i++) {
                        if (currentDayEvent(eventData[i])) {
                            todaysEvents.push(eventData[i]);
                        }
                    }

                    return todaysEvents;
                }

                function updateEvents() {
                    var todaysEvents = getTodaysEvent(); 
                    console.log(todaysEvents)             
                    var enterSelection = eventChart.selectAll("rect")
                                .data(todaysEvents)
                                .enter()

                    // Bigger transparent Interested rect
                    enterSelection.append("rect")
                        .attr("x", function(d) {
                            return xScale(parseInt(d.start_time.slice(-5,-3)));
                        })
                        .attr("width", function(d) {
                            return xScale(parseInt(d.end_time.slice(-5,-3))) - xScale(parseInt(d.start_time.slice(-5,-3)))
                        })
                        .attr("fill", function(d, i) {
                            return cScale(i);
                        })
                        .attr("y", function(d) {
                            var y = yScale(d.attending_count+d.interested_count)
                            if (isNaN(y)) {
                                console.log("ERROR")
                                d3.select(this).attr("fill", "#ccc")
                                return errorHeight;
                            } 
                            else return y;
                        })
                        .attr("height", 0)
                        .style("opacity", 0.5)
                        .transition()
                        .duration(50)
                        .attr("height", function(d) {
                            var h =  height - yScale(d.attending_count+d.interested_count);
                            console.log(h)
                            if (isNaN(h)) {
                                return height - errorHeight;
                            }
                            else return h
                        })
                        
                    // Smaller opaque attending rect 
                    enterSelection.append("rect")
                        .attr("x", function(d) {
                            return xScale(parseInt(d.start_time.slice(-5,-3)));
                        })
                        .attr("width", function(d) {
                            return xScale(parseInt(d.end_time.slice(-5,-3))) - xScale(parseInt(d.start_time.slice(-5,-3)))
                        })
                        .attr("fill", function(d, i) {
                            return cScale(i);
                        })
                        .attr("y", function(d) {
                            var y = yScale(d.attending_count)
                            if (isNaN(y)) {
                                return;
                            } 
                            else return y;
                        })
                        .attr("height", 0)
                        .transition()
                        .duration(50)
                        .attr("height", function(d) {
                            var h =  height - yScale(d.attending_count);
                            console.log(h)
                            if (isNaN(h)) {
                                return;
                            }
                            else return h
                        }) 

                    d3.select("#eventList").selectAll("h4")  
                        .data(todaysEvents)
                        .enter()
                        .append('h4')
                        .attr('class', 'eventLabel')
                        .text(function(d) {
                            if( typeof d.label != 'undefined'){
                                console.log(d.label)
                                return [d.label, d.title].join(": ");             
                            }
                            else {
                                return d.title;
                            }
                        })
                        .style("color", function(d, i) {
                            return cScale(i);
                        }) 
                }

                function clearEvents() {
                    eventChart.selectAll("rect").remove();
                    d3.selectAll(".eventLabel").remove();
                }

                function updateTimeGraphic() {
                    d3.select("#date").text(currentTime.toDateString());
                }

                function checkDayChange() {
                    return !(previousTickDay.toDateString() === currentTime.toDateString())
                }

                function updateGraphic() {
                    updateTimeGraphic();
                    clearEvents();
                    updateEvents(); 
                    isHoliday();
                }

                function updatePrevTickDay() {
                    previousTickDay = new Date(currentTime.toDateString())

                }

                function tick() {
                    updateTime();
                    if(checkDayChange()) {
                        updateGraphic();                 
                        updatePrevTickDay();
                    }
                }

                function isHoliday() {
                    if (currentTime.getTime() > winterBreakStart.getTime() && currentTime.getTime() < winterBreakEnd) {
                        d3.select("#breakTag").html("Winter Break &#10052;");
                    }
                    else {
                        d3.select("#breakTag").text("");
                    }
                }

                d3.select(window)
                    .on("scroll.scroller", tick);

                var xScale = d3.scale.linear()
                                .range([0, width])
                                .domain([9, 23])

                var yScale = d3.scale.linear()
                                .range([height, 0])
                                .domain([
                                    d3.min(eventData, function(d) {
                                        return Math.min(d.interested_count, d.attending_count);
                                    }),
                                    d3.max(eventData, function(d) {
                                        return d.interested_count + d.attending_count;
                                    })
                                ])

                var cScale = d3.scale.category10()

                var xAxis = d3.svg.axis()
                            .scale(xScale)
                            .orient("bottom")
                            .tickFormat(function(d) {
                                return d + ":00";   
                            })

                var yAxis = d3.svg.axis()
                            .scale(yScale)
                            .orient("left")   
                            .outerTickSize(0)

                var xAxisg = eventChart.append("g")
                                .call(xAxis)
                                .attr("transform", "translate(0,"+height+")")
                                .attr("class", "axis")

                var yAxisg = eventChart.append("g")
                                .call(yAxis)
                                .attr("class", "axis")

                var xAxisLabel = eventChart.append("text")
                                    .attr("y", fullHeight-50)
                                    .attr("x", width/2-15)
                                    .text("Time")

            }

        </script>
    </body>
</html>